



### [Статья по решению совместно с Sber Med AI](https://habr.com/ru/companies/sberbank/articles/779452/)

## ЭКГ-сигналы и искусственный интеллект
Для начала давайте немного разберёмся в методе электрокардиографии. Он заключается в представлении электрической активности сердца в виде электрокардиограммы. Первые ЭКГ-сигналы были записаны ещё в XIX веке французским физиком Габриэлем Липпманом, когда стало ясно, что сердце во время своей работы производит некоторое количество электричества. Со временем метод развивался и на данный момент является одним из ведущих способов определения сердечно-сосудистых заболеваний.

Электрокардиограмма представляет собой хронологическую последовательность разностей потенциалов между электродами, закрепленными на конечностях и груди человека. Наверное, все помнят кушетку и присоски в кабинете врача, которые надолго оставляют после себя следы. Эти разности потенциалов называются отведениями, чаще всего в диагностике используется 12 отведений – этакий золотой стандарт.

Важна также форма самой ЭКГ, которая определяется по 5 зубцам: P, Q, R, S и T. Они формируют интервалы различной формы и длины. Сигнал начинается с волны P, представляющей начало сердцебиения, за которой следует комплекс QRS, отражающий процесс удара сердца. После QRS идет волна T, символизирующая конец сердцебиения. Схематическое изображение этого процесса у отведения I нормального ЭКГ-сигнала показано ниже:  
  
![image](https://github.com/Artsel288/MyocardPredictor/assets/80222124/5a68c5e7-b905-4fcc-b975-7d612971007b)


Измерение длин интервалов и их амплитуд позволяет оценить состояние сердечно-сосудистой системы и выявить возможные нарушения в ее работе.
Измерение длин интервалов и их амплитуд позволяет оценить состояние сердечно-сосудистой системы и выявить возможные нарушения в ее работе.
Помимо отведений, запись ЭКГ происходит с определённой частотой, которая измеряется в герцах (число измерений в секунду). В наборе данных, который мы подготовили для соревнования, частота записи равна 500 Герц (то есть, 500 измерений сигнала в секунду), по времени запись сигнала длится 10 секунд. Таким образом, каждая запись по пациенту включает 12x500x10 = 60 000 измерений. 

Стоит отметить, что область анализа электрокардиограмм методами ИИ является довольно обширной и активно исследуется – на сегодняшний день опубликовано большое количество работ на тему классификации, сегментации и даже генерации ЭКГ-сигналов. Также, недавно в рамках публичного бенчмарка MedBench мы запустили задачу multi-label классификации ЭКГ-сигналов. Данные для задачи взяли из публичного датасета PTB-XL и переразметили 3 тысячи записей с помощью ведущих врачей-кардиологов (по схеме консенсуса асессоров) согласно отечественному тезаурусу сердечных патологий.

Новая разметка предполагает более качественное и полное представление о сигналах, из которых удалось выделить 73 класса, описывающих наличие возможных сердечных патологий или служебно-технических характеристик сигнала. Соревновательная задача во многом основывается на этой работе.

Итоговая постановка звучала следующим образом: построить модель определения наличия и локализации инфаркта миокарда по ЭКГ-сигналу. 

Для этого из исходных 73 классов были выбраны относящиеся к целевой патологии 6 итоговых подклассов, описывающих возможную локализацию инфаркта миокарда, а именно, нижний, передне-перегородочный, перегородочный, передний, передне-боковой и боковой + класс “норма”. Итоговое распределение данных выглядело следующим образом:  
  
![image](https://github.com/Artsel288/MyocardPredictor/assets/80222124/9fafcd5a-3cbe-41f7-85ce-a293a06d9aad)  
  
## Метрика, на основе которой решения участников сравнивались на лидербордах, была F1-мера. Она считается по формуле:  
  

![image](https://github.com/Artsel288/MyocardPredictor/assets/80222124/78fbe96f-4706-420a-88b4-f6da158815b8)  
  
где    
  
![image](https://github.com/Artsel288/MyocardPredictor/assets/80222124/bb5c56ab-d7b3-452c-8ace-3f71d3e788d7)  
  
  Эта метрика позволяет оценить качество модели на датасетах с дисбалансом классов, сравнивая количество верно классифицированных объектов (TP или True Positives), ложноположительных (FP или False Positives) и ложноотрицательных (FN или False Negatives).  
  
В финальном этапе команды должны были решить более сложную задачу multi-label классификации, а именно предсказать наличие или отсутствие всех 7 классов. По итогу также проверялся код, использовался закрытый тест и была защита решения. Кроме этого участникам предлагалась возможность реализовать API, демонстрирующий итоговое решение команды, например, в виде телеграм-бота или веб-сервиса. За это начислялись бонусные баллы. По итогам этапа выбиралось три команды-победителя.  
  
В течение всего соревнования было проведено 4 раунда встреч с участниками: welcome-вебинар на старте, в котором рассказали о актуальности задачи; по ходу решения провели две полноценные консультации с командами, на которых слушали идеи ребят и давали технические оценки и советы; а также финальную защиту решений в конце соревнования.  

## Full Pipeline  

  ### Модели  
  В качестве архитектуры взяли кастомную модель в виде объединения трансформерных и сверточных блоков, а в качестве лосса использовали бинарную кросс-энтропию. Выходы этой модели конкатенировали и подавали в полносвязный слой, который возвращал вероятность принадлежности ЭКГ-сигнала к тому или иному классу. На вход же подавали отрезки сигнала по 800 измерений с шагом 100, для каждой записи вероятность со всех отрезков ЭКГ усредняли.  
  
![image](https://github.com/Artsel288/MyocardPredictor/assets/80222124/97d78ffd-e9ac-41bf-966c-518cec341f2a)





### Итоговое решение  

1) Определение, есть ли инфаркт – бинарная классификация;

2) Классификация локализации инфаркта в зависимости от выходов первой модели - мультилейбл классификация.

Для моделей обоих этапов взяли предыдущую архитектуру, у бинарной модели оставили один нейрон на выходе, а у второй модели – шесть нейронов на выходе. Каждая модель обучалась отдельно друг от друга; 90% данных использовалось для обучения, остальное для валидации. Для обеих моделей мы искали лучший трешхолд перебором, основываясь на валидационной выборке и максимизации метрики F_1. После того, как нашли лучшее количество эпох и трешхолд, обучали обе модели уже на полном объёме данных. Для первой модели удалось получить F_1= 0.72, для второй F_1= 0.54.  


Так как задача сложнее, чем бинарная классификация, то для того, чтобы добиться хороших результатов, мы решили делить данные на отрезки по 700 измерений с шагом 50, таким образом, мы получили большее количество отрезков, а, значит, ещё больше данных!  

  ![image](https://github.com/Artsel288/MyocardPredictor/assets/80222124/eb727b1f-4206-4c08-9b78-6946a8b828e7)

### Преимущества нашего подхода:

- Простота архитектуры нейросети;

- Очень быстрый инференс (время порядка 5 секунд на всю тестовую выборку);

- Возможность предсказывать результаты для последовательностей ЭКГ любой длины;

 - Возможность получать как метки классов, так и вероятностные оценки;

 - Многозадачность.

### Потенциальные улучшения:

 - Обучение нескольких моделей для каждой локализации внутри записи сигнала;

 - Использование различных отведений из ЭКГ для анализа каждой локализации;

 - Использование разреженной последовательности целиком, чтобы модель лучше "понимала" полную структуру записи;

 - Балансировка сэмплов или их дополнительная генерация;

 - Использование более продвинутых способов подбора трешхолда.
   
## Файлы  
  
FULL_FINAL.ipynb - блокнот с обучением бинарной и 6-классовой модели и экспериментами  
INFERENCE.ipynb - блокнот с инференсом решения  
models.py - модели  
utils.py - вспомогательные функции  
requirements.txt - версии библиотек  
public_data - тестовые данные  
models - модели  
AIIJC_FLASK_DEMO - сайт  
  
Для просчёта решения необходимо установить все библиотеки из requirements.txt и прогнать файл инференса  


## Использование Сайта  

  
Для запуска сайта необходимо запустить файл main.py  
  
На самом сайте на главной странице будет 2 поля загрузки файлов.  
- В первый надо загружать архив, в котором 
лежит список всех npy файлов. После обработки, результаты сохранятся в json.
- Во второе окно загрузки надо загружать csv файл по типу sample_submission.txt.  
- На странице с пользователями есть список всех загруженных пользователей, по каждому из которых можно  
посмотреть график и наличие болезней.  
- Также есть поиск по точному названию совпадению названия измерения.  
- Справа сверху на странице пользователей есть кнопка экспорта данных, которая экспортирует файл в  
формате загруженного sample_submission.csv, заменив строчки с обработанными пользователями на верные.  

  ![image](https://github.com/Artsel288/MyocardPredictor/assets/80222124/96fbbfeb-b42a-4d0e-ba76-a78d656d43b1)
